# 開発ガイドライン - GitHub Copilot向け

本ドキュメントは、今後のコード生成時に注意すべき点や、過去の修正依頼から学んだベストプラクティスをまとめたものです。

## 1. ファイル命名規則と構造

### 1.1 HLSLシェーダファイル命名
- **必須**: シェーダステージをファイル名末尾のSuffixで明示
  - ComputeShader: `_cs.hlsl`
  - VertexShader: `_vs.hlsl`
  - PixelShader: `_ps.hlsl`
- **エントリポイント**: `main_[ステージ]` (例: `main_cs`, `main_vs`, `main_ps`)
- **例**: `cbt_tess_init_leaf_cs.hlsl` → エントリポイント: `main_cs`

### 1.2 ファイルエンコーディング
- **C++/Hファイル**: UTF-8 BOM付きで作成
- **HLSLファイル**: ASCII文字のみ使用（日本語コメント禁止）
  - コンパイルエラーの原因: "non-ASCII characters are not allowed outside of literals and identifiers"

## 2. シェーダ開発における統一ルール

### 2.1 定数バッファの統一
- **問題**: CPP側とHLSL側で定数バッファ定義が異なる
- **解決**: 構造体メンバーを完全一致させる
  ```cpp
  // CPP側
  struct CBTConstants {
      uint32_t cbt_tree_depth;
      uint32_t total_half_edges;  // 追加要
  };
  
  // HLSL側
  cbuffer CBTTessellationConstants {
      uint cbt_tree_depth;
      uint total_half_edges;      // 一致必須
  };
  ```

### 2.2 重複した定数バッファの排除
- **問題**: 個別シェーダで独自の`cbuffer`を定義
- **解決**: 共通の`cbt_tess_common.hlsli`で統一定義を使用
- **削除対象**: `InitConstants`等の個別シェーダ専用定数バッファ

### 2.3 スレッドグループサイズの統一
- **マクロ使用**: `CBT_THREAD_GROUP_SIZE` (128) を共通定義
- **適用**: `[numthreads(CBT_THREAD_GROUP_SIZE, 1, 1)]`
- **例外**: 特殊用途（1スレッド実行等）のみ個別指定

## 3. リソース管理とアーキテクチャ

### 3.1 GPUリソースのクラス化
- **目的**: 関連リソースの一元管理
- **実装**: `CBTGpuResources`クラスでバッファ群を管理
- **利点**: 初期化、バインド処理の統一化

### 3.2 DispatchHelper パターン
- **目的**: 自動グループ数計算とスレッドグループサイズ統一
- **使用法**: `pso->DispatchHelper(command_list, work_size, 1, 1)`
- **従来**: 手動計算 `Dispatch((work_size + GROUP_SIZE - 1) / GROUP_SIZE, 1, 1)`

## 4. コメントとドキュメント

### 4.1 日英表記の使い分け
- **HLSL**: 英語コメントのみ（コンパイル互換性）
- **C++**: 日本語可能（プロジェクト要件により）
- **設計ドキュメント**: 日本語メイン、技術用語は英語併記

### 4.2 技術ドキュメントの充実
- **目的**: CBT等の複雑なアルゴリズムの理解促進
- **内容**: アルゴリズム概要、メモリレイアウト、パフォーマンス考慮事項
- **場所**: `cbt_tess_common.hlsli` 等の共通ヘッダー

## 5. 過去の修正事例から学ぶ

### 5.1 シェーダファイル命名の修正
- **問題**: `_cs.hlsl` サフィックスなしのシェーダファイル
- **対応**: 一括リネーム（11ファイル）
- **教訓**: 命名規則は最初から遵守

### 5.2 定数バッファ統合の修正
- **問題**: `total_half_edges` フィールドの不一致
- **対応**: HLSL側に追加、個別定数バッファ削除
- **教訓**: CPP/HLSL間の構造体は同時更新

### 5.3 コンパイルエラーの修正
- **問題**: 日本語コメントによるシェーダコンパイルエラー
- **対応**: 包括的な英語翻訳（50+箇所）
- **教訓**: 多言語環境でのコンパイル互換性確保

## 6. 開発フロー推奨事項

### 6.1 変更時のチェックリスト
1. **ファイル命名**: 規則に従っているか
2. **定数バッファ**: CPP/HLSL間で一致しているか
3. **スレッドグループ**: 統一マクロを使用しているか
4. **コメント**: HLSL内に日本語がないか
5. **リソース管理**: 適切なクラス構造になっているか

### 6.2 段階的実装アプローチ
1. **基盤整備**: 共通定義、マクロ、クラス構造
2. **個別実装**: 各シェーダパスの実装
3. **統合テスト**: パイプライン全体の動作確認
4. **最適化**: パフォーマンスチューニング

## 7. 今後の発展方向

### 7.1 パフォーマンス最適化
- Wave intrinsics活用
- メモリアクセスパターン最適化
- Indirect Dispatch活用

### 7.2 保守性向上
- テストシェーダの充実
- デバッグ支援機能の拡張
- エラーハンドリングの強化

---

**更新履歴**
- 2025/07/20: 初版作成（CBTテッセレーションシステム開発経験より）
